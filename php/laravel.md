# Laravel Study Note

- Laravelで勉強したことを記録することで、自分のモチベーションを高めたい
- 細かいことは公式ドキュメントに任せて、要点とキーワードだけを網羅するように心がけたい。凝りだすとキリがないし...
- Trying to write as much content as possible in English

## TOC

1. [Setup](#setup-project)
1. [Session & Cookie](#session)
1. [](#)
1. [](#)

## Files

### (root)	
- .env
    - Config sensitive env params. Therefore you must add this file to the .gitignore
    - Keys in this file can be referred inside the project; `env('APP_DEBUG', false)` where second arg is default value when the value is not defined
    - Settings:
    ```
    DB_CONNECTION=mysql
    DB_HOST=127.0.0.1
    DB_PORT=3306
    DB_DATABASE=mydb
    DB_USERNAME=john
    DB_PASSWORD=password1234
    ```
- .gitattributes	
- .gitignore	      
- artisan
    - artisan commandの本体？
- composer.json
    - Composer equivalent of npm package.json
- composer.lock
    - Composer Equivalent of npm package-lock.json
- package.json
- package-lock.json	
- phpunit.xml
    - unit test setting
- server.php
    - codes to start servers
- webpack.mix.js	
- yarn.lock	
			
### app/
Files inside this directory will be autoloaded by Composer. When you use `make: `family Artisan commands, subdirs will be added to this app/ dir

- app/Broadcasting
    - `php artisan make:channel`
    - What's Event broadcasting???
- app/Console
    - Define how you interact with the app with CLI Includes all the user-defined "artisan" command settings
        
- app/Events
    - `php artisan make:event`
    - `php artisan event:generate`
- app/Listeners
    - This is the counterpart listeners of app/Events 
- app/Exceptions	
        
- app/Http
    - Define how you interact with the app with HTTP protocol Includes the Controllers, Middlewares, Requests
- app/Http/Middleware
	- `php artisan make:middleware`
- app/Http/Controllers
	- `php artisan make:controller`
- app/Http/Kernel.php
    - Register user-defined MW here
- app/Jobs
    - `php artisan make:job`
- app/Mail	
- app/Notifications	
- app/Policies	
- app/Providers
    - Main bodies of Service Providers
    - maybe List of Service Providers are defined in the config/app.php
- app/Rules	
- app/User.php
    - User authentication
			
### bootstrap/
Set initial actions which will be executed in the beginning of the entire app. In the world of programming, "Bootstrapping" means starting the entire process (OS, framework, codes, etc.) without any input, by itself.

- bootstrap/app.php
    - Starting file of the entire framework (?)
- bootstrap/cache/
	- Caches are important to accerelate entire framework
			
### config/			Config files directory
- config/broadcasting.php
    - Config Broadcast
- config/app.php
    - Config Service Providers providersという配列に、providerを逐次追加していく タイムゾーンの設定もここ
- config/database.php
    - Config DB
- config/session.php
	- Config Session
    
### database/			You put DB migrations, model factories, and seeds You don't put the DB itself
		
- database/migrations/
    - `php artisan make:migration`
- database/seeds/
    - `php artisan make:seeder`
- database/seeds/DatabaseSeeder.php
    - Register user-defined seeders to this file
- database/seeds/PeopleTableSeeder.php
    - Put user-defined file in this format here
			
### public/
外部にそのまま公開されるファイルの置き場
	
- public/index.php
    - Entry point for all the Req Configure autoloading Holds CSS/images/JS
			
### resources/
Holds Views Holds raw SASS / LESS/ JS to be compiled

- resources/js/bootstrap.js
    - instantiate Laravel Echo instance

- resources/views/
    - Put template files (either vanilla index.php or index.blade.php)

- resources/views/CONTROLLER_NAME_1/
- resources/views/CONTROLLER_NAME_2/
    - 雑然とテンプレートをおいていくのではなく、対応するコントローラ毎にテンプレートをまとめておくのが慣習
    - コントローラに無関係なViewは、サブディレクトリではなく直接置く
			
			
### routes/	

- routes/web.php
    - RouteServiceProvider
    - Manage "web" middleware group
    - resources/viewsにあるBladeテンプレートへのルーティングはここに記述する
    
- routes/api.php
    - RouteServiceProvider
    - Manage "api" middleware group

- routes/console.php
    - Define Closure-based console commands

- routes/channels.php
    - Register Event Broadcasting Channels
			
### storage/			
Files created by the internal program: Compiled Blade templates, File-based sessions Cache Files, and other Various Files generated by frameworks

- storage/app
    - Files generated by application

- storage/app/public
    - Files generated by the user; such as User avatar In this case, you need to make "symbolic link(what?)" to this directory in public/storage dir

- storage/framework
    - Files generated by Framework

- storage/logs
			
### tests/
PHPUnit Note that all the test classes must start from "Test" word
			
### vendor/
フレームワーク本体のプログラムが置かれている dependencies for Composer



## Laravelでの基本的な処理手順

1. `public/index.php` Laravel Appの入り口。nginxやApache側から最初に投げられる場所
1. `app/Http/Kerne.php`
1. Service Provider
1. `routers/web.php` ここでrouting
1. Middleware 認証、データ加工、redirect, etc.
1. Controller　DBへのアクセス
1. Middleware


## (Install Composer)

## (Install Laravel)

## Set up MySQL

1. `sudo apt install mysql-server`
1. `sudo mysql`
1. `ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'your_new_password_here';`
1. `sudo /etc/init.d/mysql stop`
1. `sudo /etc/init.d/mysql start`
1. `sudo apt install php-mysql` Install DB Extension


## Set up the project <a name="setup-project"></a>

1. `laravel new myapp`
1. `cd myapp`
1. `npm install`
1. `composer install`
1. `cp .env.sample .env`
1. `php artisan key:generate`

## Set up the DB

## Set up Middlewares

- Middleware Group
- Global Middleware
- 

## Set up Migrations & Seeders

`php artisan make:migration create_members_table`

## Set up Controllers

`php artisan make:controller UsersController`


## Set up Service Providers

1. `php artisan make:provider TestServiceProvider`
1. Register the service class to `register()` @`app/providers/TestServiceProvider.php` : この動作は「bindする」と呼ばれる
1. Register service provider itself @`config/app.php`


## Composer

- `composer install`
- `composer install --dev`
- `composer install --no-dev`
- `composer update`
    - Run this after you edit composer.json
- `composer require --dev phpunit/phpunit ^6.2`
- `composer install`



## Set up Blade


## Event Broadcasting

### What is "event" in the first place?

### What's this?
- Sending the 
- WebSocket
- With broadcasting, you can implement useful functions such as:
    - Real-time notification on the website

### How to broadcast

- A. Pusher
- B. Redis

### Procedure to add broadcasting

1. Register `App\Providers\BroadcastServiceProvider::class,` @config\app.php (By default, this line is just commented out)
1. Set broadcast deriver @.env
1. `php artisan make:event TaskAdded`
1. Edit the generated event file:
    ```php
    use Illuminate\Contracts\Broadcasting\ShouldBroadcast;

    class TaskAdded implements ShouldBroadcast
    {
        use Dispatchable, InteractsWithSockets, SerializesModels;
    }
    ```


### Directive
Vue.jsを使うなら、Bladeのディレクティブはそんなに覚えなくて問題ないけど。以下くらいは抑えるべき

- @if
- @for
- @foreach


## Routing 

- routes/web.phpで定義するのが基本
- コントローラからルートを定義することもある

### 基本のRouting


- `Route::get('/user', 'UserController@index');`

Route Parameters
- `Route::get('user/{id}', 'UserController@show');`
- Regular Expression
```php
Route::get('user/{id}/{name}', function ($id, $name) {
    // 処理
})->where(['id' => '[0-9]+', 'name' => '[a-z]+']);
```



Routingにmiddlewareを組み合わせる
- `Route::get('profile', 'UserController@show')->middleware('auth');`: 外部に書く
- `Route::post($uri, $callback);`

### Resource Controller

`php artisan make:controller PhotoController --resource --model=Photo`: CRUDに則ったルーティングが自動で一括生成される

`Route::resource()`

```php
Route::resource('users', 'AdminUserController')
->parameters([
    'users' => 'admin_user'
]);
```

### Routing MISC

- `php artisan route:list`
    - List all the routing inside the project



## Authentication (認証)

- 認証関係の設定はだいたい`config/auth.php`

- Laravelでの認証の種類
    - ログイン認証
    - Laravel Passport
    - API認証

- ログインを要求するページとログイン不要の公開ページをどのようにして一括登録するのか？
    - おそらくmiddleware groupだと思うが
- ログインページをどのようにしてカスタマイズするのか？

- `Auth::routes();`

### Add auth to your project

1. Define migration file for the Users table (created by default)
1. Migrate
1. `php artisan make:auth`

### Guard
- Web Guard: sessionによる認証
- API Guard: tokenによる認証




## Authorization (認可)

- 認証が本人確認なのに対して、認可は権限の付与っぽい

### Gateによる認可

### Policyによる認可

### misc
- "localhost:8000/login"などのルートはweb.phpではなく、`Illuminate\Routing\Router.php`にある



### 他の便利機能

`Route::redirect('/here', '/there', 301);`

`Route::view('/welcome', 'welcome', ['name' => 'Taylor']);`


## Session & Cookie <a name="session"></a>

### そもそもセッションってなんだっけ？

- Session IDはユーザを識別するための番号
- Session IDをブラウザ側で保管する場所が、Cookie
- Session IDをサーバー側で保管する場所が、Session
- HTTPはstateless。しかし実用的なウェブサイトでは、ページ移動しても状態を保持できなきゃお話にならない。だからセッションができた
- 実装では、DBにユーザ情報を記憶する。こういうカラム
    - id
    - user_id
    - ip_address
    - user_agent
    - payload
    - last_update


### そもそもクッキーってなんだっけ？

- Cookieはkeyとvalueのペアからなる
- ChromeのDevTool > Application TabでCookieを確認可能
    - ここに書いてあるユーザIDは暗号化されるので、DBの値とは別物
- Cookieのデータには制約も多い
    - expirationあり。設定しない場合ブラウザが閉じると破棄される
    - Max size: 4096 bytes / domain, 50 cookies / domain
- Cookieの値はユーザ側で変えたい放題だと思うけど、それを使って他のユーザだと偽ることもできる？

### misc

- Session Driver: Choose one @ .env
    - database
    - cookie: サーバー側でもcookieとして保存？なんか管理しずらそう
    - file
    - redis

### 使用手順

1. `SESSION_DRIVER=database`
1. `php artisan config:clear` Reflect the change in .env
1. `php artisan make:migration create_sessions_table`
1. Add schema to the migration file
1. Migrate
1. ``
1. ``


## Maintenance

- `composer dump-autoload` なぜか大体これをやれば解決
- `composer update` composer.jsonを更新した時にやる？



## Bootstrap
- 

## Composer View:

## Validator

## Middleware

## View Composer

- What's this?
    - Viewがレンダリングされるとき（つまりコントローラでview()が実行される時）に呼び出されるコールバック関数かクラスメソッドのこと
    - viewがrenderされるたびに情報を変数として結合する
    - View Composerはサービスプロバイダを通じて登録する

- View Composer vs Controller
    - DBへのアクセス、日付の挿入などを行えるという点で両者は共通している？？？
    - じゃあどう使い分けるのか？

- Advantage:
    - MVCを徹底できる； View logicをコントローラに書かず、またBlade template側にもロジックを入れないようにする
    - 
    
### View Creator



### Service Container / Service Provider / Dependency Injection
- サービスとは、メールの送信、暗号化、ファイル操作、などLaravelにおける操作の単位。サービスの実体はクラスのインスタンス。
- サービスコンテナは名前のごとく、サービスの容れ物。つまりクラスのインスタンスを管理する。「管理」というのはサービスの受け入れや取り出しに加えて、サービス同士の依存関係（クラスAがインスタンス化される前にクラスBがインスタンス化されている必要がある、など）を解決することも含む。
    - bind(): コンテナに新しいサービスを登録する。実行するたびに新しいインスタンスを生成する
    - singleton(): コンテナに新しいサービスを登録する。何度実行しても同じインスタンスを使いまわす
    - app(): コンテナ内のサービス一覧を確認
    - make(): コンテナからサービスを取り出す
- サービスプロバイダは、サービスをサービスコンテナにサービスを登録するのが仕事。


## MVC vs ADR

## DB Facade vs Eloquent

- StackOverflowを見る限り、DB Classを使うことを推す人が結構いる。速度がEloquentよりずっと速いとか
- ただし、自分みたいに使うデータがめちゃくちゃ少ない場合にはEloquentでORMの使い方に慣れるほうが良さそう

## Laravel + Vue.js

1. `composer require laravel/ui
1. `php artisan ui vue --auth`
1. `npm install`
1. `npm install vue` 不要？
1. `npm install vue-router` 不要？
1. `npm run dev`
1. Create Vue Component @resources/js/components/MyComponent.vue
1. Register Vue Component to resources/js/app.js: `Vue.component('example-component', require('./components/ExampleComponent.vue').default);`
1. Create resources/js/router.js for Vue Router
1. Add `<router-link>` and `<router-view>` to Blade file
1. `npm run watch`
1. `php artisan serve`


## Laravel実行環境の選択肢
- ローカルにインストール：　一番普通だけど、ローカル環境汚染が嫌なのと、複数パソコンで同一環境を再現するのが面倒
- Laradock：　王道のDocker。一番実用的な気がする。日本語のネット情報も豊富
- Homestead：　VirtualBox + Vagrant。公式が推奨してるけど、本当にそんなに使われているのか？
- Laravel Valet：　Mac専用だから自分には関係ない
